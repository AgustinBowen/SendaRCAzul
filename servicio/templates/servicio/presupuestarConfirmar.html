{% extends 'layouts/baseForm.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block extracss %}{{block.super}}
<link href="{%static 'css/presConfirmar.css'%}" rel="stylesheet" />
{% endblock %}
{% block title %}
<h1 class="titulo">Presupuestar Servicio <span class="operacion">> Resumen Presupuesto: {{ presupuesto.cliente.nombre }}
        {{ presupuesto.cliente.apellido }}</span></h1>
<a href="{% url 'presupuestarFrecuencias' %}" class="btn-atras"><i class="bi bi-arrow-left"></i> Atras</a>
{% endblock %}
{% block formulario %}
<div class="contenedorConfirmar"> 
    <section class="listasConfirmar">
        <div class="tablasConfirmarContainer">
            <ul class="opcionesListasConfirmar" id="opcionesCheckOut">
                <li class="liOpcionesListasConfirmar">
                    <a class="linkOpcionesListasConfirmar" style="width: auto; display: flex; gap:5px;" aria-current="page" href="#"
                        data-lista="tablaTiposServicios">Tipos
                        de Servicios <span class="badge bg-primary rounded-pill" id="servicios-badge"></span></a>
                </li>
                <li class="liOpcionesListasConfirmar">
                    <a class="linkOpcionesListasConfirmar" style="width: auto; display: flex; gap:5px;" href="#"
                        data-lista="tablaFrecuencias">Frecuencias <span class="badge bg-primary rounded-pill" id="frecuencias-badge"></span></a>
                </li>
            </ul>
            <table class="tablaConfirmar table table-hover" id="tablaTiposServicios">
                <thead>
                    <tr>
                        <th scope="col">Descripción</th>
                        <th scope="col">Cantidad</th>
                        <th scope="col">Precio Unitario</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in tipo_Servicios %}
                        <tr class="fila-tabla">
                            <td scope="row">{{ s.tipo_servicio.descripcion }}</td>
                            <td scope="row">{{ s.cantidad }}</td>
                            <td scope="row">{{ s.tipo_servicio.getPrecioFormateado }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <table class="tablaConfirmar table table-hover" id="tablaFrecuencias">
                <thead>
                    <tr>
                        <th scope="col">Día</th>
                        <th scope="col">Turno</th>
                    </tr>
                </thead>
                <tbody>
                    {% for frecu in frecuencias %}
                        <tr class="fila-tabla">
                            <td scope="row">{{ frecu.dia }}</td>
                            <td scope="row">{{ frecu.turno }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    <section class="infoServicioConfirmar">
        <h5 class="mb-2" style="font-family: 'InterSemiBold',sans-serif;">Servicio #{{ presupuesto.pk }}</h5>
        <p class="texto">Fecha Emisión: <span class="datoCliente">{{fecha_actual}}</span></p>
        <hr class="my-3">
        <h6 class="mb-2" style="font-family: 'InterSemiBold',sans-serif;">Cliente Información</h6>
        <div>
            <div class="miniContenedorConfirmar">
                <p class="texto datosCliente">Cliente</p>
                <span class="datoConfirmar">{{presupuesto.cliente.nombre}} {{presupuesto.cliente.apellido}}</span>
            </div>
            <div class="miniContenedorConfirmar">
                <p class="texto">CUIT/CUIL</p>
                <span class="datoConfirmar">{{presupuesto.cliente.cuil}}</span>
            </div>
            <div class="miniContenedorConfirmar">
                <p class="texto">Email</p>
                <span class="datoConfirmar">{{presupuesto.cliente.email}}</span>
            </div>
            <div class="miniContenedorConfirmar">
                <p class="texto">Telefono</p>
                <span class="datoConfirmar">{{presupuesto.cliente.telefono}}</span>
            </div>
        </div>
        <hr class="my-3">
        <h6 class="mb-2" style="font-family: 'InterSemiBold',sans-serif;">Inmueble Información</h6>
        <div>
            <div class="miniContenedorConfirmar">
                <p class="texto">Dirección Inmueble</p>
                <span class="datoConfirmar">{{presupuesto.direccion}}</span>
            </div>
            <div class="miniContenedorConfirmar">
                <p class="texto">Metros cuadrados Inmueble</p>
                <span class="datoConfirmar">{{presupuesto.metros2}}m²</span>
            </div>
        </div>
        <hr class="my-3">
        <h6 class="mb-2" style="font-family: 'InterSemiBold',sans-serif;">Servicio Información</h6>
        <div>
            <div class="miniContenedorConfirmar">
                <p class="texto">Plazo Vigencia</p>
                <span class="datoConfirmar">10 días desde la fecha de emisión</span> 
            </div>
            <div class="miniContenedorConfirmar">
                <p class="texto datosCliente">Total Servicios</p>
                <span class="datoConfirmar" id="totalServicios"></span> 
            </div>
            <div class="miniContenedorConfirmar">
                <p class="texto">Total Servicios * Frecuencias</p>
                <span class="datoConfirmar">{{ total_servicios }}</span>   
            </div>
            <div class="miniContenedorConfirmar">
                <p class="texto">Mano de Obra</p>
                <span class="datoConfirmar">{{ mano_obra }}</span> 
            </div>
            <div class="miniContenedorConfirmar">
                <p class="texto">Ganancia 15%</p>
                <span class="datoConfirmar">{{ porcentaje_ganancia }}</span> 
            </div>
            <div class="miniContenedorConfirmar">
                <p class="texto">Importe Sugerido</p>
                <span class="datoConfirmar">{{ importe_total_formateado }}</span> 
            </div>
            <div class="miniContenedorConfirmar">
                <p class="texto" id="totalConfirmar">Total</p>
                <span class="datoConfirmar" id="importe_total_span">{{ importe_total_formateado }}</span> 
            </div>
            <div class="importes" style="display: flex; align-items: center; gap: 10px;justify-content: end;">
                <div id="porcentaje-badge-container"></div>
            </div>
        </div>
        <form class="mi-form" novalidate="" method="GET">
            <div class="row g-2">
                {% csrf_token %}
                <div>
                    {{ form.cantidad_empleados | as_crispy_field }}
                    <span class="badge rounded-pill bg-danger" id="error_message"></span>
                    <input type="hidden" name="{{ form.importe_sugerido.name }}" value="{{ importe_sugerido }}">
                </div>
                <div>
                    {{ form.porcentaje | as_crispy_field }}
                    <input type="hidden" name="{{ form.importe_total.name }}" value="{{ importe_total }}">
                </div>
                <input type="hidden" name="{{ form.nuevo_importe_total.name }}" id="{{ form.nuevo_importe_total.id }}">
                <hr class="my-3">
                <div>
                    <button class="w-100 btn btn-lg confirmar-presupuesto" type="submit">Confirmar Presupuesto</button>
                </div>
        </form>       
    </section>
</div>
{% endblock %}
{% block extrajs %}
<script>
    $(document).ready(function () {
        $('#id_cantidad_empleados').on('input', function () {
            const cantidadEmpleados = $(this).val();
            // Realizar la solicitud AJAX al backend
            $.ajax({
                url: '/servicio/presupuestarConfirmar/',
                method: 'GET',
                data: {
                    cantidad_empleados: cantidadEmpleados,
                },
                success: function (data) {
                    if (data.error) {
                        // Mostrar el error en tu formulario
                        $('#error_message').text(data.error).show();
                        $('.confirmar-presupuesto').prop('disabled', true);
                        // Puedes desactivar el botón de enviar u otras acciones aquí
                    } else {
                        // Si no hay error, actualizar la página normalmente
                        console.log("estoy en la salida buena de la peticion de ajax")
                        $('#error_message').hide();
                        $('.confirmar-presupuesto').prop('disabled', false);
                        let dataFormateada = parseFloat(data.importe_total).toLocaleString('es-AR', {
                            style: 'currency',
                            currency: 'ARS',
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                        $('#importe_total_span').text(dataFormateada);
                        $('input[name="{{ form.importe_total.name }}"]').val(data.importe_total);
                    }
                },
            });
        });

        // Función para calcular la suma total de precios
        function calcularSumaTotal() {
            let sumaTotal = 0;

            $('#tablaTiposServicios tbody tr').each(function () {
                let cantidadString = $(this).find('td:nth-child(2)').text();
                let precioString = $(this).find('td:nth-child(3)').text().replace(/\./g, '').replace(',', '.').replace(/[^\d.-]/g, '');
                
                let cantidad = parseInt(cantidadString);
                let precio = parseFloat(precioString);

                if (!isNaN(precio) && !isNaN(cantidad)) {
                    sumaTotal += precio * cantidad;
                }
            });

            return sumaTotal;
        }

        // Función para actualizar la cantidad de elementos y badges
        function actualizarCantidadElementos() {
            let cantidadServicios = $('#tablaTiposServicios tbody tr').length;
            $('#servicios-badge').text(cantidadServicios);

            let cantidadFrecuencias = $('#tablaFrecuencias tbody tr').length;
            $('#frecuencias-badge').text(cantidadFrecuencias);
        }

        function agregarBadgePorcentaje(porcentaje, porcentajeValorImporteTotal) {
            // Crear el badge con el contenido adecuado
            let badge = $('<span class="badge bg-primary rounded-pill" style="margin-bottom:10px; font-size: 13px;"></span>');
            badge.text((porcentaje >= 0 ? '+ ' : '') + porcentajeValorImporteTotal.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2, maximumFractionDigits: 2 }));

            // Insertar el badge en el contenedor
            $('#porcentaje-badge-container').empty().append(badge);
        }

        // Función para actualizar el importe total con el porcentaje y la cantidad de empleados
        function actualizarImporteTotal() {
            $('input[name="{{ form.porcentaje.name }}"]').on('input', function () {
                let porcentaje = parseFloat($(this).val()) || 0;
                let porcentajeViejo = parseFloat("{{ importe_total }}")
                let importeTotalOriginal = parseFloat("{{ importe_total }}");
                let porcentajeValorImporteTotal = (importeTotalOriginal * (porcentaje / 100))
                let nuevoImporteTotal = importeTotalOriginal + porcentajeValorImporteTotal;
                let nuevoImporteTotalFormateado = nuevoImporteTotal.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2, maximumFractionDigits: 2 });

                // Actualizar solo el valor del badge del importe total
                $('#importe_total_span').text(nuevoImporteTotalFormateado);

                // Actualizar el valor del campo oculto en el formulario
                $('input[name="{{ form.importe_total.name }}"]').val(nuevoImporteTotal);

                agregarBadgePorcentaje(porcentaje, porcentajeValorImporteTotal);
            });
        }

        $('#opcionesCheckOut a').on('click', function (e) {
            e.preventDefault();

            // Obtener el id de la lista correspondiente
            const listaId = $(this).data('lista');
            console.log(listaId)

            // Ocultar todas las listas y luego mostrar la lista seleccionada
            $('#tablaTiposServicios,#tablaFrecuencias').hide();
            $('#' + listaId).show();

            // Agregar la clase 'active' al enlace clicado y eliminarla de los demás
            $('#opcionesCheckOut a').removeClass('active');
            $(this).addClass('active');
        });

        // Simular clic en el enlace "Tipos de Servicios" al cargar la página
        $('#opcionesCheckOut a[data-lista="tablaTiposServicios"]').click();

        // Inicializar la suma total y actualizar badges al cargar la página
        let sumaTotalInicial = calcularSumaTotal();
        $('#totalServicios').text('$' + sumaTotalInicial.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
        actualizarCantidadElementos();
        actualizarImporteTotal();
    });

    $(function () {
        $('.confirmar-presupuesto').click(function () {
            $(".mi-form").attr('method', 'POST').submit()
        })
    })
</script>
{% endblock %}