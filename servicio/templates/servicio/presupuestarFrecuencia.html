{% extends 'layouts/baseForm.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extracss %}{{ block.super }}
<link href="{% static 'css/formset.css' %}" rel="stylesheet" />
{% endblock %}

{% block title %}
<h1 class="titulo">Presupuestar Servicio</h1>
<div class="container-info">
    <h2 class="operacion">Agregar Frecuencia / {{presupuesto.cliente.nombre}} {{presupuesto.cliente.apellido}}</h2>
</div>
{% endblock %}

{% block formulario %}
<div class="container">
    <form method="POST" class="mi-formset">
        {% csrf_token %}
        {{ formset.management_form }}

        <div id="form-frecuencias" class="row g-3 form-group form-set">
            {% for f in formset %}
            <div class="col-md-5 form-frecuencia bg-dark text-white">
                <button type="button" class="quitar-frecuencia quitar-form">Quitar</button>
                {{ f|crispy }}
            </div>
            {% endfor %}
        </div>
        <div class="container-acciones mt-2">
            <button type="button" class="accion agregar-frecuencia">Añadir Frecuencia</button>
            <a href="{% url 'presupuestarServicios' %}" class="accion">Volver</a>
            <button type="submit" class="accion btn-siguiente-vista">Siguiente</button>
        </div>
    </form>
</div>
{% endblock %}
{% block extrajs %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const isFrecuencia = document.getElementById('form-frecuencias') !== null;
        const prefix = isFrecuencia ? 'frecuencia' : 'servicio';
        const containerId = isFrecuencia ? 'form-frecuencias' : 'form-servicios';
        const addButtonClass = isFrecuencia ? 'agregar-frecuencia' : 'agregar-servicio';
        const removeButtonClass = isFrecuencia ? 'quitar-frecuencia' : 'quitar-servicio';
    
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const container = document.getElementById(containerId);
        const emptyFormTemplate = `{{ formset.empty_form|crispy|escapejs }}`;
    
        // Crea un nuevo formulario reemplazando el __prefix__
        function buildForm(index) {
            const wrapper = document.createElement('div');
            wrapper.className = `col-md-5 form-${prefix} bg-dark text-white position-relative mb-3`;
            wrapper.innerHTML = `
                <button type="button" class="${removeButtonClass} quitar-form">Quitar</button>
                ${emptyFormTemplate.replace(/__prefix__/g, index)}
            `;
            return wrapper;
        }
    
        // Agrega un nuevo formulario al final
        function addForm() {
            const currentTotal = parseInt(totalForms.value);
            const form = buildForm(currentTotal);
            container.appendChild(form);
            totalForms.value = currentTotal + 1;
            bindRemoveButtons();
            if (isFrecuencia) bindTurnoChange(form); // solo si es frecuencia
        }
    
        // Elimina un formulario y reindexa todos
        function removeForm(button) {
            const formElement = button.closest(`.form-${prefix}`);
            if (!formElement) return;
            formElement.remove();
    
            const forms = container.querySelectorAll(`.form-${prefix}`);
            forms.forEach((form, i) => {
                const inputs = form.querySelectorAll('input, select, textarea, label');
                inputs.forEach(el => {
                    if (el.name) el.name = el.name.replace(/form-\d+-/, `form-${i}-`);
                    if (el.id) el.id = el.id.replace(/form-\d+-/, `form-${i}-`);
                    if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/form-\d+-/, `form-${i}-`);
                });
            });
    
            totalForms.value = forms.length;
        }
    
        // Asocia eventos de eliminación
        function bindRemoveButtons() {
            const buttons = container.querySelectorAll(`.${removeButtonClass}`);
            buttons.forEach(button => {
                button.onclick = () => removeForm(button);
            });
        }
    
        // Evento especial para mostrar horario según turno
        function bindTurnoChange(form) {
            const selectTurno = form.querySelector("select[name$='turno']");
            if (!selectTurno) return;
    
            selectTurno.addEventListener('change', function () {
                const valor = this.value;
                form.querySelectorAll('.container-hora').forEach(e => e.remove());
    
                let texto = '';
                if (valor == "1") texto = '8:00 a 12:00';
                else if (valor == "2") texto = '14:00 a 18:00';
                else if (valor == "3") texto = '19:00 a 23:00';
    
                const div = document.createElement('div');
                div.className = 'container-hora';
                div.innerHTML = `<h6 class="texto">${texto} <i class="bi bi-clock"></i></h6>`;
                selectTurno.insertAdjacentElement('afterend', div);
            });
        }
    
        // Botón de añadir formset
        document.querySelector(`.${addButtonClass}`).addEventListener('click', () => {
            addForm();
        });
    
        // Botón de enviar formulario
        document.querySelector('.btn-siguiente-vista')?.addEventListener('click', () => {
            document.querySelector('.mi-formset').submit();
        });
    
        // Inicialización al cargar
        bindRemoveButtons();
        if (isFrecuencia) {
            document.querySelectorAll(`.form-${prefix}`).forEach(bindTurnoChange);
        }
    });
    </script>
       
{% endblock %}
